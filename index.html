<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Get RTB Delegators</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script type="text/javascript" src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
</head>

<body>
    <nav id="nav" class="navbar bg-secondary">
        <div class="container-fluid">
          <a class="navbar-brand mx-auto" href="#">
            <img src="https://raw.githubusercontent.com/rtb131/assets/main/red_logo.png" width=80px alt="">
            <span class="fs-1 text-white align-middle">Raison D'etre Pool Delegators</span>
          </a>
          
        </div>
      </nav>

    <div class="container">
        <div id="input" class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text">Minimum Amount ₳</span>
            </div>
            <input id="minAmount" type="number" class="form-control"
                onkeypress='return event.charCode >= 48 && event.charCode <= 57'
                onkeydown="if (event.keyCode == 13) document.getElementById('getDelegatorsButton').click()">

            <button id="getDelegatorsButton" class="btn btn-dark btn-outline-secondary text-white"
                onclick="getDelegators()">Get Delegators</button>

            <button id="exportButton" class="bi bi-file-earmark-spreadsheet btn btn-dark btn-outline-success text-white"
                style="display:none" onclick="ExportToExcel('xlsx')"> Export Data</button>
        </div>

        <table id="table_data" class="table table-striped table-dark table-bordered border-secondary">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Stake Address</th>
                    <th>Amount (₳)</th>
                </tr>
            </thead>
            <tbody id="data">
            </tbody>
        </table>
    </div>

</body>
<style>

    #nav {
        background-image: linear-gradient(to right top, #370505, #2c0608, #220509, #160206, #000000);
    }
    #minAmount {
        max-width: 200px
    }


    body {
        background-color: black;
    }

    .container {
        margin-top: 50px
    }

</style>
<script>

    const apiKey = 'mainnetLttamuf9FTGQnt8Ca8PAZYH3wO42u0ic'
    const poolId = 'e116bf936475165924795ae3f2dda01ab4a893ad8444a1364dd5886b'
    const url = `https://cardano-mainnet.blockfrost.io/api/v0/pools/${poolId}/delegators`
    

    function getDelegators() {
        let id = 1
        document.getElementById("exportButton").style.display = "none";

        minAmount = document.getElementById('minAmount').value
        if (minAmount == '') { minAmount = 0 }
        let temp = "";

        if (isNaN(minAmount)) {
            alert("Please enter a valid minimum Amount")
        } else {
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'project_id': apiKey
                }
            }).then(
                res => {
                    res.json().then(
                        data => {
                            console.log(data);

                            if (data.length > 0) {

                                data.forEach((itemData) => {
                                    amount = (itemData.live_stake / 1000000).toFixed(2)
                                    console.log("amount:" + amount + " minAmount:" + minAmount)

                                    // only write addresses into table that stake at least minAmount ADA into the pool
                                    if (amount > parseFloat(minAmount)) {
                                        temp += "<tr>";
                                        temp += "<td>" + id++ + "</td>";
                                        temp += "<td>" + itemData.address + "</td>";
                                        temp += "<td>" + amount + "</td></tr>";
                                    }
                                });

                                if (temp) {
                                    document.getElementById("exportButton").style.display = "block";
                                }
                                document.getElementById('data').innerHTML = temp;
                            }
                        }
                    )
                }
            )
        }
    }


    function ExportToExcel(type, fn, dl) {
        var elt = document.getElementById('table_data');
        var wb = XLSX.utils.table_to_book(elt, { sheet: "sheet1" });
        datetime = new Date().toISOString().split('.')[0].replace("T", "_")
        return dl ?
            XLSX.write(wb, { bookType: type, bookSST: true, type: 'base64' }) :
            XLSX.writeFile(wb, fn || (`RTBPoolDelegators_${datetime} UTC.` + (type || 'xlsx')));
    }

</script>

</html>
