<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Get RTB Delegators</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script type="text/javascript" src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
</head>

<body onload="getDelegators()">
    <nav id="nav" class="navbar bg-secondary">
        <div id="header" class="container-fluid" style="display: invisible">
            <a class="navbar-brand mx-auto .text-center"
                href="https://adapools.org/pool/e116bf936475165924795ae3f2dda01ab4a893ad8444a1364dd5886b">
                <span id="poolName" class="fs-1 text-white align-middle">[RTB] Pool</span>
                <img src="https://raw.githubusercontent.com/rtb131/assets/main/red_logo.png" width=80px alt="">
                <span id="currentEpoch" class="fs-1 text-white align-middle">Epoch 000</span>
            </a>

        </div>
    </nav>

    <div class="container">
        <div id="input" class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text">Minimum Amount ₳</span>
            </div>
            <input id="minAmount" type="number" class="form-control"
                onkeypress='return event.charCode >= 48 && event.charCode <= 57'
                onkeydown="if (event.keyCode == 13) document.getElementById('getDelegatorsButton').click()">

            <div class="input-group-prepend">
                <span class="input-group-text">Minimum Epochs</span>
            </div>
            <input id="minEpochs" type="number" class="form-control"
                onkeypress='return event.charCode >= 48 && event.charCode <= 57'
                onkeydown="if (event.keyCode == 13) document.getElementById('getDelegatorsButton').click()">

            <button id="getDelegatorsButton" class="btn btn-dark btn-outline-secondary text-white"
                onclick="getDelegators()">Get
                Delegators</button>

            <button id="exportButton" class="bi bi-file-earmark-spreadsheet btn btn-dark btn-outline-success text-white"
                style="display:none" onclick="ExportToExcel('xlsx')"> Export Data</button>
        </div>

        <table id="table_data" class="table table-striped table-dark table-bordered border-secondary">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Stake Address</th>
                    <th>Amount (₳)</th>
                    <th>Since Epoch</th>
                    <th>Epochs Staked</th>
                </tr>
            </thead>
            <tbody id="data">
            </tbody>
        </table>
    </div>

</body>
<style>
    #nav {
        background-image: linear-gradient(to right top, #370505, #2c0608, #220509, #160206, #000000);
    }

    .form-control {
        max-width: 200px;
        margin-right: 20px
    }

    body {
        background-color: black;
    }

    .container {
        margin-top: 50px
    }
</style>
<script>
    const apiKey = 'mainnetLttamuf9FTGQnt8Ca8PAZYH3wO42u0ic'
    const poolId = 'pool1uyttlymyw5t9jfrett3l9hdqr2623yads3z2zdjd6kyxkg8hpn7'
    const url = `https://cardano-mainnet.blockfrost.io/api/v0/pools/${poolId}/delegators`

    async function getDelegators() {
        class HttpClient {
            constructor(options = {}) {
                this._baseURL = options.baseURL || "";
                this._headers = options.headers || {};
            }

            async _fetchJSON(endpoint, options = {}) {
                const res = await fetch(this._baseURL + endpoint, {
                    ...options,
                    headers: this._headers
                });

                if (!res.ok) throw new Error(res.statusText);

                if (options.parseResponse !== false && res.status !== 204)
                    return res.json();

                return undefined;
            }

            setHeader(key, value) {
                this._headers[key] = value;
                return this;
            }

            getHeader(key) {
                return this._headers[key];
            }

            get(endpoint, options = {}) {
                return this._fetchJSON(endpoint, {
                    ...options,
                    method: "GET"
                });
            }

        }

        const httpClient = new HttpClient({ baseURL: 'https://cardano-mainnet.blockfrost.io/api/v0' })
            .setHeader('project_id', apiKey)

        let id = 1
        let table = ''
        let minAmount = document.getElementById('minAmount').value
        let minEpochs = document.getElementById('minEpochs').value
        if (minAmount == '') { minAmount = 0 }

        document.getElementById("exportButton").style.display = "none";

        if (isNaN(minAmount) || isNaN(minEpochs)) {
            alert("Please enter a valid minimum Amount")
        }

        let currentEpoch = await httpClient.get('/epochs/latest')
        currentEpoch = currentEpoch.epoch

        document.getElementById("currentEpoch").innerHTML = "Epoch " + currentEpoch

        const delegators = await httpClient.get(`/pools/${poolId}/delegators`)

        if (delegators.length > 0) {
            for await (delegator of delegators) {

                let stake_address = delegator.address
                let amount = (delegator.live_stake / 1000000).toFixed(2)

                if (amount >= parseFloat(minAmount)) {
                    const delegationInfo = await httpClient.get(`/accounts/${stake_address}/delegations`)

                    let sinceEpoch = ''
                    for await (info of delegationInfo) {

                        if (info.pool_id == poolId) {
                            if (!sinceEpoch) {
                                sinceEpoch = info.active_epoch - 2
                            }
                        }
                    }

                    let consecutiveEpochsStaked = parseInt(currentEpoch) - parseInt(sinceEpoch)

                    if (minEpochs <= consecutiveEpochsStaked) {
                        table += "<tr>";
                        table += "<td>" + id++ + "</td>";
                        table += "<td>" + stake_address + "</td>";
                        table += "<td>" + amount + "</td>";
                        table += "<td>" + sinceEpoch + "</td>";
                        table += "<td>" + consecutiveEpochsStaked + "</td></tr>";
                    }

                    if (table) {
                        document.getElementById("exportButton").style.display = "block";
                    }

                    document.getElementById('data').innerHTML = table;
                }
            }
        }
    }


    function ExportToExcel(type, fn, dl) {
        var elt = document.getElementById('table_data');
        var wb = XLSX.utils.table_to_book(elt, { sheet: "sheet1" });
        datetime = new Date().toISOString().split('.')[0].replace("T", "_")
        return dl ?
            XLSX.write(wb, { bookType: type, bookSST: true, type: 'base64' }) :
            XLSX.writeFile(wb, fn || (`RTBPoolDelegators_${datetime} UTC.` + (type || 'xlsx')));
    }

</script>

</html>
